<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Account Settings - Concert Finder</title>
    <link rel="stylesheet" href="/style.css">
</head>

<body>
    <header>
        <div class="header-content">
            <h2>Welcome to Concert Finder</h2>
            <p>Hello, <span id="usernameDisplay"></span>!</p>
        </div>
        <nav class="navbar">
            <button onclick="location.href='/'" class="btn">Home</button>
            <button onclick="location.href='/account-settings'" class="btn active">Account Settings</button>
            <button onclick="logout()" class="btn">Logout</button>
        </nav>
    </header>

    <section id="passwordChangeSection">
        <h2>Change Password</h2>
        <form id="passwordChangeForm">
            <div class="form-group">
                <label for="currentPassword">Current Password:</label>
                <input type="password" id="currentPassword" name="currentPassword" required>
            </div>
            <div class="form-group">
                <label for="newPassword">New Password:</label>
                <input type="password" id="newPassword" name="newPassword" required>
            </div>
            <div class="form-group">
                <label for="confirmPassword">Confirm Password:</label>
                <input type="password" id="confirmPassword" name="confirmPassword" required>
            </div>
            <div class="form-action">
                <button type="submit" class="btn">Update Password</button>
            </div>
        </form>
    </section>

    <script>
        document.addEventListener('DOMContentLoaded', function () {
            fetch('/api/isLoggedIn')
                .then(response => response.json())
                .then(data => {
                    if (data.isLoggedIn) {
                        fetch('/get-username')
                            .then(response => response.text())
                            .then(username => {
                                document.getElementById('usernameDisplay').textContent = username;
                            });
                    } else {
                        window.location.href = '/login';
                    }
                });
        });

        document.getElementById('passwordChangeForm').addEventListener('submit', function (event) {
            event.preventDefault();
            const currentPassword = document.getElementById('currentPassword').value.trim();
            const newPassword = document.getElementById('newPassword').value.trim();
            const confirmPassword = document.getElementById('confirmPassword').value.trim();

            console.log(`Submitting: currentPassword=${currentPassword}, newPassword=${newPassword}, confirmPassword=${confirmPassword}`);

            if (newPassword !== confirmPassword) {
                alert("New passwords do not match.");
                return;
            }

            fetch('/change-password', {
                method: 'POST',
                headers: { 'Content-Type': 'application/x-www-form-urlencoded' },
                body: `currentPassword=${encodeURIComponent(currentPassword)}&newPassword=${encodeURIComponent(newPassword)}&confirmPassword=${encodeURIComponent(confirmPassword)}`
            })
                .then(response => {
                    if (response.ok) {
                        alert('Password updated successfully!');
                        window.location.href = '/account-settings';
                    } else {
                        response.text().then(text => {
                            console.error('Server response:', text);
                            alert(text);
                        });
                    }
                })
                .catch(error => {
                    console.error('Error updating password:', error);
                    alert('Failed to update password.');
                });
        });


        function logout() {
            fetch('/logout', { method: 'POST' })
                .then(response => {
                    if (response.ok) {
                        window.location.href = '/login';
                    } else {
                        alert('Failed to log out.');
                    }
                })
                .catch(error => {
                    console.error('Error logging out:', error);
                });
        }
    </script>
</body>

</html>